<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HardwareForge - Storage</title>
  <link rel="stylesheet" href="public/css/bootstrap.min.css" />
  <link rel="stylesheet" href="public/css/dropdown.css" />
  <link rel="stylesheet" href="public/css/storage.css" />
  <script src="public/js/security.js" defer></script>
</head>
<body class="dark">
  <div class="wrapper d-flex">
    <aside id="sidebar-container" class="sidebar"></aside>
    <main class="main-content flex-grow-1 py-5">
      <div class="flex-container py-5">
        <div class="container-fluid">
          <h2 class="text-center mb-4">Select Your Storage</h2>
          <div class="row">
            <div class="col-md-2" id="filter-column">
              <!-- Advanced Filters Section -->
              <div class="card mb-4 filter-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Advanced Filters</h5>
                  <button class="btn btn-sm btn-outline-secondary" id="clearFiltersBtn">Clear All</button>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <label class="form-label">Form Factor</label>
                      <select class="form-select" id="formFactorFilter">
                        <option value="">All Form Factors</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Interface</label>
                      <select class="form-select" id="interfaceFilter">
                        <option value="">All Interfaces</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Capacity</label>
                      <select class="form-select" id="capacityFilter">
                        <option value="">All Capacities</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Storage Type</label>
                      <select class="form-select" id="storageTypeFilter">
                        <option value="">All Types</option>
                        <option value="SSD">SSD</option>
                        <option value="HDD">HDD</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label class="form-label">Price Range</label>
                      <div class="input-group">
                        <span class="input-group-text">RM</span>
                        <input type="number" class="form-control" id="minPrice" placeholder="Min" min="0" max="20000" step="10">
                        <span class="input-group-text">-</span>
                        <input type="number" class="form-control" id="maxPrice" placeholder="Max" min="0" max="20000" step="10">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-10">
              <div class="row mb-2">
                <div class="col-10">
                  <div class="input-group">
                    <span class="input-group-text">üîç</span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search storages...">
                  </div>
                </div>
              </div>

              <div id="storage-grid"></div>
              <div id="pagination-container" class="mt-4 text-center"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="dropdown-container"></div>
  <script>
    const itemsPerPage = 15;
    let storages = [];
    let filteredStorages = [];
    let currentPage = 1;

    function populateFilters() {
      // Get unique values for filters
      const formFactors = [...new Set(storages.map(s => s.form_factor))];
      const interfaces = [...new Set(storages.map(s => s.interface))];
      const capacities = [...new Set(storages.map(s => s.capacity))].sort((a, b) => {
        // Sort by numeric value (extract number from capacity string)
        const numA = parseFloat(a) || 0;
        const numB = parseFloat(b) || 0;
        return numB - numA;
      });

      // Populate form factor filter
      const formFactorFilter = document.getElementById('formFactorFilter');
      formFactors.forEach(formFactor => {
        if (formFactor) {
          const option = document.createElement('option');
          option.value = formFactor;
          option.textContent = formFactor;
          formFactorFilter.appendChild(option);
        }
      });

      // Populate interface filter
      const interfaceFilter = document.getElementById('interfaceFilter');
      interfaces.forEach(interface_ => {
        if (interface_) {
          const option = document.createElement('option');
          option.value = interface_;
          option.textContent = interface_;
          interfaceFilter.appendChild(option);
        }
      });

      // Populate capacity filter
      const capacityFilter = document.getElementById('capacityFilter');
      capacities.forEach(capacity => {
        if (capacity) {
          const option = document.createElement('option');
          option.value = capacity;
          option.textContent = capacity;
          capacityFilter.appendChild(option);
        }
      });
    }

    function applyFilters() {
      const formFactor = document.getElementById('formFactorFilter').value;
      const interface_ = document.getElementById('interfaceFilter').value;
      const capacity = document.getElementById('capacityFilter').value;
      const storageType = document.getElementById('storageTypeFilter').value;
      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 20000;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      filteredStorages = storages.filter(storage => {
        // Form Factor filter
        if (formFactor && storage.form_factor !== formFactor) return false;
        
        // Interface filter
        if (interface_ && storage.interface !== interface_) return false;
        
        // Capacity filter
        if (capacity && storage.capacity !== capacity) return false;
        
        // Storage Type filter
        if (storageType && storage.storage_type !== storageType) return false;
        
        // Price range filter
        if (storage.price < minPrice || storage.price > maxPrice) return false;
        
        // Search filter
        if (searchTerm && !storage.name.toLowerCase().includes(searchTerm)) return false;
        
        return true;
      });
      
      currentPage = 1;
      displayStorages();
      setupPagination();
    }

    function clearAllFilters() {
      document.getElementById('formFactorFilter').value = '';
      document.getElementById('interfaceFilter').value = '';
      document.getElementById('capacityFilter').value = '';
      document.getElementById('storageTypeFilter').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      document.getElementById('searchInput').value = '';
      
      filteredStorages = [...storages];
      currentPage = 1;
      displayStorages();
      setupPagination();
    }

    function displayStorages() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const currentItems = filteredStorages.slice(start, end);

      const grid = document.getElementById('storage-grid');
      grid.innerHTML = '';

      if (currentItems.length === 0) {
        grid.innerHTML = "<p class='text-center text-muted'>No storage devices found matching your criteria.</p>";
        return;
      }

      currentItems.forEach(storage => {
        const col = document.createElement('div');
        col.className = 'storage-col';

        const imageUrl = storage.image_url && storage.image_url.trim() !== ""
          ? (storage.image_url.startsWith("http")
              ? storage.image_url
              : `/images/${storage.image_url.replace(/^images[\\/]/, "")}`)
          : "https://via.placeholder.com/250x200?text=No+Image";

        col.innerHTML = `
          <div class="storage-card text-center shadow-sm p-3 mb-4 rounded">
            <img src="${imageUrl}" alt="${storage.name}" width="250" class="mb-2" onerror="this.src='https://via.placeholder.com/250x200?text=No+Image'; this.onerror=null;">
            <h6 class="fw-semibold">${storage.name}</h6>
            <div class="storage-specs text-muted small">
              <div class="d-flex justify-content-between">
                <span>Type: ${storage.storage_type || 'N/A'}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Form Factor: ${storage.form_factor || 'N/A'}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Interface: ${storage.interface || 'N/A'}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Capacity: ${storage.capacity || 'N/A'}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Speed: ${storage.readwrite || 'N/A'}</span>
              </div>
            </div>
            <p class="text-success fw-bold mt-2">RM ${parseFloat(storage.price).toFixed(2)}</p>
            <button class="btn btn-sm btn-primary add-button">Add to Build</button>
          </div>
        `;

        col.querySelector('.add-button').addEventListener('click', () => {
          const selectedStorage = {
            name: storage.name,
            price: parseFloat(storage.price),
            image_url: storage.image_url,
            storage_type: storage.storage_type,
            form_factor: storage.form_factor,
            interface: storage.interface,
            capacity: storage.capacity,
            readwrite: storage.readwrite
          };
          localStorage.setItem('selectedStorage', JSON.stringify(selectedStorage));
          window.location.href = 'build.html';
        });

        grid.appendChild(col);
      });
    }

    function setupPagination() {
      const totalPages = Math.ceil(filteredStorages.length / itemsPerPage);
      const container = document.getElementById('pagination-container');
      container.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn mx-1 btn-outline-primary';
        prevBtn.textContent = 'Previous';
        prevBtn.onclick = () => {
          currentPage--;
          displayStorages();
          setupPagination();
        };
        container.appendChild(prevBtn);
      }

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          const btn = document.createElement('button');
          btn.className = `btn mx-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
          btn.textContent = i;
          btn.onclick = () => {
            currentPage = i;
            displayStorages();
            setupPagination();
          };
          container.appendChild(btn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'mx-1';
          container.appendChild(dots);
        }
      }

      // Next button
      if (currentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn mx-1 btn-outline-primary';
        nextBtn.textContent = 'Next';
        nextBtn.onclick = () => {
          currentPage++;
          displayStorages();
          setupPagination();
        };
        container.appendChild(nextBtn);
      }
    }

    // Event listeners with debouncing for inputs
    let searchTimeout;
    
    document.getElementById('searchInput').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });

    document.getElementById('minPrice').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });

    document.getElementById('maxPrice').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });

    // Auto-apply on dropdown change
    ['formFactorFilter', 'interfaceFilter', 'capacityFilter', 'storageTypeFilter'].forEach(id => {
      document.getElementById(id).addEventListener('change', applyFilters);
    });

    // Clear filters button
    document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

    // Initialize
    fetch('http://localhost:3001/api/storages')
      .then(res => res.json())
      .then(data => {
        storages = data;
        filteredStorages = [...storages];
        if (storages.length > 0) {
          populateFilters();
          displayStorages();
          setupPagination();
        } else {
          document.getElementById('storage-grid').innerHTML =
            "<p class='text-center text-muted'>No storage devices found.</p>";
        }
      })
      .catch(err => {
        console.error('Failed to load storages:', err);
        document.getElementById('storage-grid').innerHTML =
          "<p class='text-center text-danger'>Failed to load storages.</p>";
      });
  </script>

  <script src="public/js/bootstrap.bundle.min.js"></script>
  <script src="public/js/common.js"></script>
</body>
</html>